<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>头颈癌放疗患者癌因性疲乏风险预测模型 (14变量)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 全局样式 (与之前完全一致，略作宽度适应) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;  /* 略加宽以适应14个变量 */
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 头部样式 */
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 30px 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        header h1 i {
            font-size: 2.5rem;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-left: 45px;
        }
        
        /* 主要内容区域 */
        .main-content {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .input-section, .result-section {
            flex: 1;
            min-width: 500px;  /* 增大最小宽度 */
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* 输入区域网格布局：两列显示，适应更多变量 */
        .inputs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .inputs-grid {
                grid-template-columns: 1fr;
            }
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tooltip {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            cursor: help;
            font-style: normal;
        }
        
        .input-field, select.input-field {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }
        
        .input-field:focus, select.input-field:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .range-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 4px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .min, .max {
            font-size: 0.9rem;
            color: #666;
            min-width: 30px;
        }
        
        /* 按钮样式 */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            grid-column: span 2;
        }
        
        .btn {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 150px;
        }
        
        .btn.calculate {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        
        .btn.reset {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
            color: white;
        }
        
        .btn.example {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* 结果区域样式 (保持不变) */
        .result-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #eee;
        }
        
        .risk-level {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .level-icon {
            font-size: 3rem;
            color: #95a5a6;
        }
        
        .level-text h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        .level-text p {
            color: #666;
        }
        
        .risk-meter {
            margin-bottom: 30px;
        }
        
        .meter-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .meter-bar {
            position: relative;
            height: 20px;
            background: linear-gradient(to right, #2ecc71, #f1c40f, #e74c3c);
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        .meter-pointer {
            position: absolute;
            top: -5px;
            width: 4px;
            height: 30px;
            background: #2c3e50;
            border-radius: 2px;
            transform: translateX(-50%);
            transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .meter-scale {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
        }
        
        .numerical-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .result-item {
            background: white;
            padding: 18px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .result-item.highlight {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }
        
        .label {
            font-weight: 600;
            color: #2c3e50;
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #3498db;
            display: block;
        }
        
        .result-item.highlight .value {
            color: #e74c3c;
        }
        
        .score-breakdown {
            margin-bottom: 25px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .score-breakdown h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        thead {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .recommendation {
            background: #e8f4fc;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
        
        .recommendation h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .formula-display {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #eee;
        }
        
        .formula-display h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .formula {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            line-height: 1.8;
            color: #2c3e50;
            border: 1px solid #ddd;
        }
        
        footer {
            background: #2c3e50;
            color: white;
            padding: 30px 40px;
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .footer-info {
            margin-bottom: 20px;
        }
        
        .footer-info p {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .footer-links {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
        }
        
        .footer-links a {
            color: #3498db;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: #2ecc71;
        }
        
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .input-section, .result-section {
                min-width: 100%;
            }
            
            .numerical-results {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            header {
                padding: 20px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .input-section, .result-section {
                padding: 20px;
            }
            
            footer {
                padding: 20px;
            }
            
            .footer-links {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> 头颈癌放疗患者癌因性疲乏（CRF）风险预测模型</h1>
            <p class="subtitle">基于14变量逻辑回归模型的列线图预测系统 | 表3-6系数</p>
        </header>

        <div class="main-content">
            <!-- 左侧：输入区域 -->
            <div class="input-section">
                <h2><i class="fas fa-edit"></i> 患者临床特征输入</h2>
                <div class="inputs-grid">
                    <!-- 1. 疼痛 -->
                    <div class="input-group">
                        <label for="pain">
                            <i class="fas fa-head-side-virus"></i> 疼痛
                            <span class="tooltip" data-tooltip="0=无，1=有">ⓘ</span>
                        </label>
                        <select id="pain" class="input-field">
                            <option value="0">无</option>
                            <option value="1">有</option>
                        </select>
                    </div>

                    <!-- 2. 放射性损伤 -->
                    <div class="input-group">
                        <label for="radiation">
                            <i class="fas fa-radiation"></i> 放射性损伤
                            <span class="tooltip" data-tooltip="0=无，1=有">ⓘ</span>
                        </label>
                        <select id="radiation" class="input-field">
                            <option value="0">无</option>
                            <option value="1">有</option>
                        </select>
                    </div>

                    <!-- 3. 临床分期 -->
                    <div class="input-group">
                        <label for="stage">
                            <i class="fas fa-stethoscope"></i> 临床分期
                            <span class="tooltip" data-tooltip="1=Ⅰ期，2=Ⅱ期，3=Ⅲ期，4=Ⅳ期">ⓘ</span>
                        </label>
                        <select id="stage" class="input-field">
                            <option value="1">Ⅰ期</option>
                            <option value="2">Ⅱ期</option>
                            <option value="3">Ⅲ期</option>
                            <option value="4">Ⅳ期</option>
                        </select>
                    </div>

                    <!-- 4. 社会支持 -->
                    <div class="input-group">
                        <label for="support">
                            <i class="fas fa-hands-helping"></i> 社会支持水平
                            <span class="tooltip" data-tooltip="1=低，2=中，3=高">ⓘ</span>
                        </label>
                        <select id="support" class="input-field">
                            <option value="1">低</option>
                            <option value="2">中</option>
                            <option value="3">高</option>
                        </select>
                    </div>

                    <!-- 5. 营养风险 -->
                    <div class="input-group">
                        <label for="nutrition">
                            <i class="fas fa-apple-alt"></i> 营养风险
                            <span class="tooltip" data-tooltip="0=无，1=有">ⓘ</span>
                        </label>
                        <select id="nutrition" class="input-field">
                            <option value="0">无</option>
                            <option value="1">有</option>
                        </select>
                    </div>

                    <!-- 6. 血红蛋白 (HB) -->
                    <div class="input-group">
                        <label for="hb">
                            <i class="fas fa-tint"></i> 血红蛋白 (g/L)
                            <span class="tooltip" data-tooltip="连续变量，正常范围115-150">ⓘ</span>
                        </label>
                        <input type="number" id="hb" class="input-field" value="120" min="60" max="180" step="1">
                        <div class="range-display">
                            <span class="min">60</span>
                            <input type="range" id="hb-slider" min="60" max="180" value="120" class="slider">
                            <span class="max">180</span>
                        </div>
                    </div>

                    <!-- 7. 抑郁程度 -->
                    <div class="input-group">
                        <label for="depress">
                            <i class="fas fa-brain"></i> 抑郁程度
                            <span class="tooltip" data-tooltip="1=正常，2=轻度，3=中度，4=重度">ⓘ</span>
                        </label>
                        <select id="depress" class="input-field">
                            <option value="1">正常</option>
                            <option value="2">轻度</option>
                            <option value="3">中度</option>
                            <option value="4">重度</option>
                        </select>
                    </div>

                    <!-- 8. 睡眠障碍 -->
                    <div class="input-group">
                        <label for="sleep">
                            <i class="fas fa-bed"></i> 睡眠障碍
                            <span class="tooltip" data-tooltip="0=无，1=有">ⓘ</span>
                        </label>
                        <select id="sleep" class="input-field">
                            <option value="0">无</option>
                            <option value="1">有</option>
                        </select>
                    </div>

                    <!-- 9. 白细胞计数 (WBC) -->
                    <div class="input-group">
                        <label for="wbc">
                            <i class="fas fa-flask"></i> 白细胞计数 (×10⁹/L)
                            <span class="tooltip" data-tooltip="连续变量，正常范围3.5-9.5">ⓘ</span>
                        </label>
                        <input type="number" id="wbc" class="input-field" value="6.5" min="1.0" max="20.0" step="0.1">
                        <div class="range-display">
                            <span class="min">1.0</span>
                            <input type="range" id="wbc-slider" min="1.0" max="20.0" value="6.5" step="0.1" class="slider">
                            <span class="max">20.0</span>
                        </div>
                    </div>

                    <!-- 10. 焦虑程度 -->
                    <div class="input-group">
                        <label for="anxiety">
                            <i class="fas fa-heartbeat"></i> 焦虑程度
                            <span class="tooltip" data-tooltip="1=正常，2=轻度，3=中度，4=重度">ⓘ</span>
                        </label>
                        <select id="anxiety" class="input-field">
                            <option value="1">正常</option>
                            <option value="2">轻度</option>
                            <option value="3">中度</option>
                            <option value="4">重度</option>
                        </select>
                    </div>

                    <!-- 11. 血清白蛋白 (ALB) -->
                    <div class="input-group">
                        <label for="alb">
                            <i class="fas fa-droplet"></i> 血清白蛋白 (g/L)
                            <span class="tooltip" data-tooltip="连续变量，正常范围≥35">ⓘ</span>
                        </label>
                        <input type="number" id="alb" class="input-field" value="38" min="20" max="60" step="1">
                        <div class="range-display">
                            <span class="min">20</span>
                            <input type="range" id="alb-slider" min="20" max="60" value="38" step="1" class="slider">
                            <span class="max">60</span>
                        </div>
                    </div>

                    <!-- 12. 放疗次数 -->
                    <div class="input-group">
                        <label for="radFreq">
                            <i class="fas fa-clock"></i> 放疗次数
                            <span class="tooltip" data-tooltip="1=1-10次，2=11-20次，3=21-30次，4=≥31次">ⓘ</span>
                        </label>
                        <select id="radFreq" class="input-field">
                            <option value="1">1-10次</option>
                            <option value="2">11-20次</option>
                            <option value="3">21-30次</option>
                            <option value="4">≥31次</option>
                        </select>
                    </div>

                    <!-- 13. 治疗方式 -->
                    <div class="input-group">
                        <label for="treatment">
                            <i class="fas fa-hospital"></i> 治疗方式
                            <span class="tooltip" data-tooltip="1=单纯放疗，2=同步放化疗">ⓘ</span>
                        </label>
                        <select id="treatment" class="input-field">
                            <option value="1">单纯放疗</option>
                            <option value="2">同步放化疗</option>
                        </select>
                    </div>

                    <!-- 14. 年龄 -->
                    <div class="input-group">
                        <label for="age">
                            <i class="fas fa-calendar-alt"></i> 年龄 (岁)
                            <span class="tooltip" data-tooltip="连续变量，18-100岁">ⓘ</span>
                        </label>
                        <input type="number" id="age" class="input-field" value="60" min="18" max="100" step="1">
                        <div class="range-display">
                            <span class="min">18</span>
                            <input type="range" id="age-slider" min="18" max="100" value="60" step="1" class="slider">
                            <span class="max">100</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="calculate-btn" class="btn calculate">
                        <i class="fas fa-calculator"></i> 计算CRF风险
                    </button>
                    <button id="reset-btn" class="btn reset">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                    <button id="example-btn" class="btn example">
                        <i class="fas fa-user-md"></i> 查看示例
                    </button>
                </div>
            </div>

            <!-- 右侧：结果区域 -->
            <div class="result-section">
                <h2><i class="fas fa-chart-bar"></i> 预测结果</h2>
                
                <div class="result-card">
                    <div class="risk-level" id="risk-level">
                        <div class="level-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="level-text">
                            <h3>等待计算</h3>
                            <p>请输入患者特征后点击"计算CRF风险"</p>
                        </div>
                    </div>

                    <div class="risk-meter">
                        <div class="meter-labels">
                            <span>低风险 (<20%)</span>
                            <span>中风险 (20-60%)</span>
                            <span>高风险 (>60%)</span>
                        </div>
                        <div class="meter-bar">
                            <div class="meter-fill" id="meter-fill"></div>
                            <div class="meter-pointer" id="meter-pointer"></div>
                        </div>
                        <div class="meter-scale">
                            <span>0%</span>
                            <span>25%</span>
                            <span>50%</span>
                            <span>75%</span>
                            <span>100%</span>
                        </div>
                    </div>

                    <div class="numerical-results">
                        <div class="result-item">
                            <span class="label">预测总得分：</span>
                            <span class="value" id="total-score">--</span>
                        </div>
                        <div class="result-item">
                            <span class="label">Logit(P)值：</span>
                            <span class="value" id="logit-value">--</span>
                        </div>
                        <div class="result-item highlight">
                            <span class="label">CRF风险概率：</span>
                            <span class="value" id="risk-prob">--</span>
                        </div>
                    </div>

                    <div class="score-breakdown">
                        <h4><i class="fas fa-list-ol"></i> 各变量贡献明细 (β系数)</h4>
                        <table id="score-table">
                            <thead>
                                <tr>
                                    <th>变量</th>
                                    <th>取值</th>
                                    <th>贡献值</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 由JavaScript动态填充 -->
                            </tbody>
                        </table>
                    </div>

                    <div class="recommendation" id="recommendation">
                        <h4><i class="fas fa-lightbulb"></i> 临床建议</h4>
                        <p id="recommendation-text">根据风险等级提供个体化建议...</p>
                    </div>
                </div>

                <div class="formula-display">
                    <h4><i class="fas fa-square-root-alt"></i> 计算公式</h4>
                    <div class="formula">
                        <strong>逻辑回归模型 (基于表3-6)：</strong><br>
                        logit(P) = 6.368 <br>
                        + 2.288×疼痛(有) <br>
                        + 1.882×放射性损伤(有) <br>
                        + 1.914×(临床分期-1)  <br>
                        - 1.261×(社会支持-1) <br>
                        + 1.258×营养风险(有) <br>
                        - 0.093×血红蛋白(g/L) <br>
                        + 1.007×(抑郁-1) <br>
                        + 1.149×睡眠障碍(有) <br>
                        - 0.541×白细胞计数(×10⁹/L) <br>
                        + 0.792×(焦虑-1) <br>
                        - 0.156×血清白蛋白(g/L) <br>
                        + 0.707×(放疗次数-1) <br>
                        + 0.587×治疗方式(同步放化疗) <br>
                        + 0.043×年龄(岁) <br><br>
                        <strong>风险概率：</strong> P = 1 / [1 + exp(-logit(P))]
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-info">
                <p><i class="fas fa-info-circle"></i> 本工具基于14变量逻辑回归模型构建，数据来源：表3-6 (n=650)</p>
                <p><i class="fas fa-hospital-user"></i> 适用人群：头颈癌放疗患者</p>
                <p><i class="fas fa-code"></i> 模型版本：v2.0 | 最后更新：2026年2月</p>
            </div>
            <div class="footer-links">
                <a href="#"><i class="fas fa-file-pdf"></i> 下载列线图</a>
                <a href="#"><i class="fas fa-book"></i> 研究论文</a>
                <a href="#"><i class="fas fa-bug"></i> 反馈问题</a>
                <a href="#"><i class="fas fa-share-alt"></i> 分享工具</a>
            </div>
        </footer>
    </div>

    <script>
        // β系数定义 (基于表3-6)
        const betaCoefficients = {
            intercept: 6.368,
            pain: { coef: 2.288, labels: {0: "无", 1: "有"} },
            radiation: { coef: 1.882, labels: {0: "无", 1: "有"} },
            stage: { coef: 1.914, labels: {1: "Ⅰ期", 2: "Ⅱ期", 3: "Ⅲ期", 4: "Ⅳ期"} },
            support: { coef: -1.261, labels: {1: "低", 2: "中", 3: "高"} },
            nutrition: { coef: 1.258, labels: {0: "无", 1: "有"} },
            hemoglobin: { coef: -0.093 },
            depression: { coef: 1.007, labels: {1: "正常", 2: "轻度", 3: "中度", 4: "重度"} },
            sleep: { coef: 1.149, labels: {0: "无", 1: "有"} },
            wbc: { coef: -0.541 },
            anxiety: { coef: 0.792, labels: {1: "正常", 2: "轻度", 3: "中度", 4: "重度"} },
            albumin: { coef: -0.156 },
            radFreq: { coef: 0.707, labels: {1: "1-10次", 2: "11-20次", 3: "21-30次", 4: "≥31次"} },
            treatment: { coef: 0.587, labels: {1: "单纯放疗", 2: "同步放化疗"} },
            age: { coef: 0.043 }
        };

        // 列线图得分转换参数 (模拟，可根据需要调整)
        const nomogramParams = {
            minLogit: -10,
            maxLogit: 10,
            minScore: 0,
            maxScore: 300
        };

        // DOM元素引用
        const elements = {
            pain: document.getElementById('pain'),
            radiation: document.getElementById('radiation'),
            stage: document.getElementById('stage'),
            support: document.getElementById('support'),
            nutrition: document.getElementById('nutrition'),
            hemoglobin: document.getElementById('hb'),
            hemoglobinSlider: document.getElementById('hb-slider'),
            depression: document.getElementById('depress'),
            sleep: document.getElementById('sleep'),
            wbc: document.getElementById('wbc'),
            wbcSlider: document.getElementById('wbc-slider'),
            anxiety: document.getElementById('anxiety'),
            albumin: document.getElementById('alb'),
            albuminSlider: document.getElementById('alb-slider'),
            radFreq: document.getElementById('radFreq'),
            treatment: document.getElementById('treatment'),
            age: document.getElementById('age'),
            ageSlider: document.getElementById('age-slider'),

            calculateBtn: document.getElementById('calculate-btn'),
            resetBtn: document.getElementById('reset-btn'),
            exampleBtn: document.getElementById('example-btn'),

            riskLevel: document.getElementById('risk-level'),
            meterPointer: document.getElementById('meter-pointer'),
            totalScore: document.getElementById('total-score'),
            logitValue: document.getElementById('logit-value'),
            riskProb: document.getElementById('risk-prob'),
            scoreTable: document.querySelector('#score-table tbody'),
            recommendationText: document.getElementById('recommendation-text')
        };

        // 滑块与输入框同步
        function bindSlider(input, slider) {
            slider.addEventListener('input', function() {
                input.value = this.value;
                calculateRisk();
            });
            input.addEventListener('input', function() {
                slider.value = this.value;
                calculateRisk();
            });
        }
        bindSlider(elements.hemoglobin, elements.hemoglobinSlider);
        bindSlider(elements.wbc, elements.wbcSlider);
        bindSlider(elements.albumin, elements.albuminSlider);
        bindSlider(elements.age, elements.ageSlider);

        // 计算列线图得分
        function convertToNomogramScore(logitValue) {
            const { minLogit, maxLogit, minScore, maxScore } = nomogramParams;
            const normalized = Math.max(0, Math.min(1, (logitValue - minLogit) / (maxLogit - minLogit)));
            return Math.round(minScore + normalized * (maxScore - minScore));
        }

        // 获取变量显示标签
        function getVariableLabel(variable, value) {
            if (betaCoefficients[variable] && betaCoefficients[variable].labels) {
                return betaCoefficients[variable].labels[value];
            }
            return value;
        }

        // 计算风险
        function calculateRisk() {
            // 获取输入值
            const inputs = {
                pain: parseInt(elements.pain.value),
                radiation: parseInt(elements.radiation.value),
                stage: parseInt(elements.stage.value),
                support: parseInt(elements.support.value),
                nutrition: parseInt(elements.nutrition.value),
                hemoglobin: parseFloat(elements.hemoglobin.value),
                depression: parseInt(elements.depression.value),
                sleep: parseInt(elements.sleep.value),
                wbc: parseFloat(elements.wbc.value),
                anxiety: parseInt(elements.anxiety.value),
                albumin: parseFloat(elements.albumin.value),
                radFreq: parseInt(elements.radFreq.value),
                treatment: parseInt(elements.treatment.value),
                age: parseFloat(elements.age.value)
            };

            // 计算logit值
            let logit = betaCoefficients.intercept;

            // 疼痛
            logit += betaCoefficients.pain.coef * inputs.pain;
            // 放射性损伤
            logit += betaCoefficients.radiation.coef * inputs.radiation;
            // 临床分期 (有序，以Ⅰ期为参照)
            logit += betaCoefficients.stage.coef * (inputs.stage - 1);
            // 社会支持 (有序，以低为参照)
            logit += betaCoefficients.support.coef * (inputs.support - 1);
            // 营养风险
            logit += betaCoefficients.nutrition.coef * inputs.nutrition;
            // 血红蛋白
            logit += betaCoefficients.hemoglobin.coef * inputs.hemoglobin;
            // 抑郁 (有序，以正常为参照)
            logit += betaCoefficients.depression.coef * (inputs.depression - 1);
            // 睡眠障碍
            logit += betaCoefficients.sleep.coef * inputs.sleep;
            // 白细胞计数
            logit += betaCoefficients.wbc.coef * inputs.wbc;
            // 焦虑 (有序)
            logit += betaCoefficients.anxiety.coef * (inputs.anxiety - 1);
            // 血清白蛋白
            logit += betaCoefficients.albumin.coef * inputs.albumin;
            // 放疗次数 (有序)
            logit += betaCoefficients.radFreq.coef * (inputs.radFreq - 1);
            // 治疗方式 (同步放化疗=2，单纯放疗=1，所以系数乘以 (treatment-1)？但系数0.587是相对于单纯放疗，所以 (treatment-1)*0.587)
            logit += betaCoefficients.treatment.coef * (inputs.treatment - 1);
            // 年龄
            logit += betaCoefficients.age.coef * inputs.age;

            // 计算概率
            const probability = 1 / (1 + Math.exp(-logit));

            // 转换为列线图得分
            const nomogramScore = convertToNomogramScore(logit);

            // 更新显示
            updateDisplay(inputs, logit, probability, nomogramScore);
        }

        // 更新显示
        function updateDisplay(inputs, logit, probability, nomogramScore) {
            elements.totalScore.textContent = nomogramScore;
            elements.logitValue.textContent = logit.toFixed(3);
            elements.riskProb.textContent = (probability * 100).toFixed(1) + '%';

            elements.meterPointer.style.left = (probability * 100) + '%';

            let riskLevel, riskColor, iconClass, advice;
            if (probability < 0.2) {
                riskLevel = "低风险";
                riskColor = "#2ecc71";
                iconClass = "fas fa-smile";
                advice = "患者癌因性疲乏风险较低。建议：常规健康教育，每2周评估一次疲乏症状。";
            } else if (probability < 0.6) {
                riskLevel = "中风险";
                riskColor = "#f39c12";
                iconClass = "fas fa-meh";
                advice = "患者有中等程度癌因性疲乏风险。建议：加强症状监测，提供心理支持和营养指导，每周评估症状。";
            } else {
                riskLevel = "高风险";
                riskColor = "#e74c3c";
                iconClass = "fas fa-frown";
                advice = "患者癌因性疲乏风险较高。建议：制定综合管理方案，包括多学科协作、症状管理、心理干预和营养支持，必要时转诊专科。";
            }

            elements.riskLevel.innerHTML = `
                <div class="level-icon">
                    <i class="${iconClass}" style="color: ${riskColor};"></i>
                </div>
                <div class="level-text">
                    <h3 style="color: ${riskColor};">${riskLevel}</h3>
                    <p>癌因性疲乏发生概率: ${(probability * 100).toFixed(1)}%</p>
                </div>
            `;

            elements.riskProb.style.color = riskColor;
            elements.recommendationText.textContent = advice;

            updateScoreTable(inputs, logit);
        }

        // 更新得分明细表格
        function updateScoreTable(inputs, logit) {
            // 构建贡献值列表
            const contributions = [
                { var: "疼痛", value: getVariableLabel('pain', inputs.pain), contrib: (betaCoefficients.pain.coef * inputs.pain).toFixed(3) },
                { var: "放射性损伤", value: getVariableLabel('radiation', inputs.radiation), contrib: (betaCoefficients.radiation.coef * inputs.radiation).toFixed(3) },
                { var: "临床分期", value: getVariableLabel('stage', inputs.stage), contrib: (betaCoefficients.stage.coef * (inputs.stage - 1)).toFixed(3) },
                { var: "社会支持", value: getVariableLabel('support', inputs.support), contrib: (betaCoefficients.support.coef * (inputs.support - 1)).toFixed(3) },
                { var: "营养风险", value: getVariableLabel('nutrition', inputs.nutrition), contrib: (betaCoefficients.nutrition.coef * inputs.nutrition).toFixed(3) },
                { var: "血红蛋白", value: inputs.hemoglobin + " g/L", contrib: (betaCoefficients.hemoglobin.coef * inputs.hemoglobin).toFixed(3) },
                { var: "抑郁", value: getVariableLabel('depression', inputs.depression), contrib: (betaCoefficients.depression.coef * (inputs.depression - 1)).toFixed(3) },
                { var: "睡眠障碍", value: getVariableLabel('sleep', inputs.sleep), contrib: (betaCoefficients.sleep.coef * inputs.sleep).toFixed(3) },
                { var: "白细胞计数", value: inputs.wbc + " ×10⁹/L", contrib: (betaCoefficients.wbc.coef * inputs.wbc).toFixed(3) },
                { var: "焦虑", value: getVariableLabel('anxiety', inputs.anxiety), contrib: (betaCoefficients.anxiety.coef * (inputs.anxiety - 1)).toFixed(3) },
                { var: "血清白蛋白", value: inputs.albumin + " g/L", contrib: (betaCoefficients.albumin.coef * inputs.albumin).toFixed(3) },
                { var: "放疗次数", value: getVariableLabel('radFreq', inputs.radFreq), contrib: (betaCoefficients.radFreq.coef * (inputs.radFreq - 1)).toFixed(3) },
                { var: "治疗方式", value: getVariableLabel('treatment', inputs.treatment), contrib: (betaCoefficients.treatment.coef * (inputs.treatment - 1)).toFixed(3) },
                { var: "年龄", value: inputs.age + " 岁", contrib: (betaCoefficients.age.coef * inputs.age).toFixed(3) },
                { var: "常量", value: "-", contrib: betaCoefficients.intercept.toFixed(3) }
            ];

            elements.scoreTable.innerHTML = '';
            contributions.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.var}</td>
                    <td>${item.value}</td>
                    <td>${item.contrib}</td>
                `;
                elements.scoreTable.appendChild(tr);
            });
        }

        // 重置功能
        function resetForm() {
            elements.pain.value = "0";
            elements.radiation.value = "0";
            elements.stage.value = "1";
            elements.support.value = "1";
            elements.nutrition.value = "0";
            elements.hemoglobin.value = "120";
            elements.hemoglobinSlider.value = "120";
            elements.depression.value = "1";
            elements.sleep.value = "0";
            elements.wbc.value = "6.5";
            elements.wbcSlider.value = "6.5";
            elements.anxiety.value = "1";
            elements.albumin.value = "38";
            elements.albuminSlider.value = "38";
            elements.radFreq.value = "1";
            elements.treatment.value = "1";
            elements.age.value = "60";
            elements.ageSlider.value = "60";

            elements.riskLevel.innerHTML = `
                <div class="level-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="level-text">
                    <h3>等待计算</h3>
                    <p>请输入患者特征后点击"计算CRF风险"</p>
                </div>
            `;
            elements.meterPointer.style.left = "0%";
            elements.totalScore.textContent = "--";
            elements.logitValue.textContent = "--";
            elements.riskProb.textContent = "--";
            elements.recommendationText.textContent = "根据风险等级提供个体化建议...";
            elements.scoreTable.innerHTML = `
                <tr>
                    <td colspan="3" style="text-align: center; color: #999; padding: 30px;">
                        <i class="fas fa-calculator" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        <p>输入患者特征后显示详细计算过程</p>
                    </td>
                </tr>
            `;
        }

        // 示例功能 (高风险示例，可根据需要修改)
        function loadExample() {
            elements.pain.value = "1";
            elements.radiation.value = "1";
            elements.stage.value = "4";
            elements.support.value = "1";
            elements.nutrition.value = "1";
            elements.hemoglobin.value = "90";
            elements.hemoglobinSlider.value = "90";
            elements.depression.value = "4";
            elements.sleep.value = "1";
            elements.wbc.value = "3.0";
            elements.wbcSlider.value = "3.0";
            elements.anxiety.value = "4";
            elements.albumin.value = "28";
            elements.albuminSlider.value = "28";
            elements.radFreq.value = "4";
            elements.treatment.value = "2";
            elements.age.value = "75";
            elements.ageSlider.value = "75";

            calculateRisk();
        }

        // 事件绑定
        elements.calculateBtn.addEventListener('click', calculateRisk);
        elements.resetBtn.addEventListener('click', resetForm);
        elements.exampleBtn.addEventListener('click', loadExample);

        // 所有输入变化时自动计算
        const inputElements = [
            elements.pain, elements.radiation, elements.stage, elements.support,
            elements.nutrition, elements.hemoglobin, elements.depression, elements.sleep,
            elements.wbc, elements.anxiety, elements.albumin, elements.radFreq,
            elements.treatment, elements.age
        ];
        inputElements.forEach(el => {
            el.addEventListener('change', calculateRisk);
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            resetForm();
        });

        // 工具提示 (保持不变)
        document.addEventListener('DOMContentLoaded', function() {
            const tooltips = document.querySelectorAll('.tooltip');
            tooltips.forEach(tooltip => {
                tooltip.addEventListener('mouseenter', function(e) {
                    const tooltipText = this.getAttribute('data-tooltip');
                    if (tooltipText) {
                        const tooltipDiv = document.createElement('div');
                        tooltipDiv.className = 'tooltip-popup';
                        tooltipDiv.textContent = tooltipText;
                        tooltipDiv.style.position = 'absolute';
                        tooltipDiv.style.background = '#2c3e50';
                        tooltipDiv.style.color = 'white';
                        tooltipDiv.style.padding = '8px 12px';
                        tooltipDiv.style.borderRadius = '4px';
                        tooltipDiv.style.fontSize = '0.9rem';
                        tooltipDiv.style.zIndex = '1000';
                        tooltipDiv.style.maxWidth = '250px';
                        tooltipDiv.style.boxShadow = '0 3px 10px rgba(0,0,0,0.2)';
                        
                        document.body.appendChild(tooltipDiv);
                        
                        const rect = this.getBoundingClientRect();
                        tooltipDiv.style.left = (rect.left + window.scrollX) + 'px';
                        tooltipDiv.style.top = (rect.top + window.scrollY - tooltipDiv.offsetHeight - 10) + 'px';
                        
                        this.tooltipElement = tooltipDiv;
                    }
                });
                
                tooltip.addEventListener('mouseleave', function() {
                    if (this.tooltipElement) {
                        this.tooltipElement.remove();
                        this.tooltipElement = null;
                    }
                });
            });
        });
    </script>
</body>
</html>
